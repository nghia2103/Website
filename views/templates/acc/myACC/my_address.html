<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Azeret+Mono:ital,wght@0,100..900;1,100..900&family=Barlow+Condensed:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Be+Vietnam+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Josefin+Sans:ital,wght@0,100..700;1,100..700&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Vollkorn:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      background-color: #ffffff;
    }

    .btn-custom-discard {
      background-color: #fff3cd;
      color: #000;
      border: 1px solid #ffeeba;
    }
    .btn-custom-update {
      background-color: rgb(106, 122, 0);
      color: #fff;
    }
    .profile-img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
    }
    .card {
      border-width: 1px 0 1px 0;
      border-style: solid;
      border-color: #ccc;
      border-radius: 0;
      width: 86%;
      margin-left: auto;
      margin-right: auto;
    }
    .custom-card {
      border: 0;
    }
    .lock-icon {
      display: inline-block;
      margin-left: 10px;
      cursor: pointer;
      position: relative;
    }
    .lock-icon::before {
      content: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="gray" class="bi bi-lock" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2zM5 8h6a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1z"/></svg>');
    }
    .lock-icon:hover::before {
      content: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="rgb(106, 122, 0)" class="bi bi-lock" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2zM5 8h6a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1z"/></svg>');
    }
    .lock-icon:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }
    .tooltip {
      visibility: hidden;
      opacity: 0;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 4px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      top: -40px;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      transition: opacity 0.3s;
    }
    .tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #333 transparent transparent transparent;
    }
    .btn-custom-discard {
      border-radius: 0;
      border: 1px solid rgb(106, 122, 0);
      background-color: #ffffff;
      color: rgb(106, 122, 0);
    }
    .btn-custom-discard:hover {
      text-decoration: underline;
      border-radius: 0;
      border: 1px solid rgb(106, 122, 0);
      background-color: #ffffff;
      color: rgb(106, 122, 0);
    }
    .btn-custom-update {
      border-radius: 0;
    }
    .btn-custom-update:hover {
      text-decoration: underline;
      color: white;
      background-color: rgb(106, 122, 0);
    }
    .form-control {
      border: 1px solid black;
      border-radius: 0 !important;
    }
    .nav-container22 {
      font-family: "Azeret Mono", monospace;
      background-color: #ffffff;
      padding: 10px 0;
      margin-bottom: 20px;
    }
    .nav-list22 {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      gap: 20px;
    }
    .nav-item22 {
      font-family: "Azeret Mono", monospace;
    }
    .nav-link22 {
      text-decoration: none;
      color: #000;
      font-family: "Azeret Mono", monospace;
      font-size: 16px;
      padding: 8px 12px;
      transition: color 0.3s;
    }
    .nav-link22:hover {
      color: rgb(106, 122, 0);
    }
    .nav-link22.active {
      color: rgb(106, 122, 0);
      font-weight: bold;
      border-bottom: 2px solid rgb(106, 122, 0);
    }
    .fa-brands::before {
      width: 24px;
      height: 24px;
    }
    .btn-custom-d9df6d {
      background-color: #d9df6d;
    }
    .custom-background {
      background-color: #d9df6d;
    }
    .footer-end {
      background-color: #d9df6d;
    }
    .custom-title {
      font-family: Arial Black, sans-serif;
      font-size: 83px;
    }
    .brand-graphic {
      height: 70px;
    }
    .custom-div1 {
      display: inline;
    }
    .footer {
      margin-top: 20px;
      padding: 40px;
      background-color: #d4e157;
    }
    .footer-main {
      color: black;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }
    .footer-left h1 {
      padding-top: 48px;
      font-family: Arial, sans-serif;
      color: black;
      font-size: 80px;
      font-weight: 900;
    }
    .star-icon {
      width: 68px;
      height: 68px;
      object-fit: contain;
      margin-bottom: 10px;
      animation: rotate360 5s linear infinite;
    }
    @keyframes rotate360 {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }
    .footer-center ul {
      list-style: none;
      padding: 0;
      font-size: 14px;
    }
    .footer-center li {
      margin: 5px 0;
    }
    .footer-right p {
      font-size: 14px;
      margin: 5px 0;
    }
    .footer-bottom {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      flex-wrap: wrap;
      border-top: 1px solid rgb(0, 0, 0);
      padding-top: 20px;
    }
    .social-icons {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .icon-circle {
      background-color: black;
      color: #d4e157;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      text-decoration: none;
      transition: transform 0.3s, background-color 0.3s;
    }
    .icon-circle i {
      font-size: 16px;
    }
    .footer-links a {
      margin-right: 15px;
      text-decoration: none;
      color: black;
    }
    .footer-right {
      font-family: azeret-mono, "azeret mono", monospace;
      padding-right: 400px;
      padding-top: 60px;
    }
    .footer-center {
      font-family: azeret-mono, "azeret mono", monospace;
      padding-top: 60px;
    }
    .modal-content {
      border-radius: 0;
      border: 1px solid black;
    }
    .modal-header {
      border-bottom: 1px solid black;
    }
    .modal-footer {
      border-top: 1px solid black;
    }
    #map {
      height: 200px;
      width: 100%;
      margin-bottom: 15px;
    }
    .default-badge {
      background-color: rgb(106, 122, 0);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      margin-left: 10px;
      font-family: inherit;
      font-size: inherit;
      font-weight: normal;
    }
    .list-group-item:hover {
      background-color: #f8f9fa;
    }
    .address-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      width: 100%;
      border-bottom: 1px solid rgb(81, 81, 81);
      padding-bottom: 10px
    }
    .address-list hr {
      border-top: 2px solid #333;
      margin-top: 10px;
      width: 100%;
    }
    .address-actions {
      display: flex;
      flex-direction: column;
      gap: 5px;
      align-items: flex-end;
    }
    .address-action-btn {
      background-color: #ffffff;
      color: rgb(106, 122, 0);
      border: 1px solid rgb(106, 122, 0);
      border-radius: 0;
      padding: 5px 15px;
      font-size: 14px;
      width: 100px;
      text-align: center;
    }
    .address-action-btn:hover {
      text-decoration: underline;
      background-color: rgb(106, 122, 0);
      color: #ffffff;
    }
    .address-action-btn.update-address {
      background-color: rgb(106, 122, 0);
      color: #ffffff;
    }
    .address-action-btn.update-address:hover {
      text-decoration: underline;
      background-color: rgb(137, 153, 34);
      color: #ffffff;
      border: 1px solid black;
    }
    .address-action-btn.delete-address {
      background-color: #ffffff;
      color: #dc3545;
      border: 1px solid #dc3545;
    }
    .address-action-btn.delete-address:hover {
      text-decoration: underline;
      background-color: #dc3545;
      color: #ffffff;
    }
    .address-action-btn:disabled {
      background-color: #e9ecef;
      color: #6c757d;
      border: 1px solid #6c757d;
      cursor: not-allowed;
    }
    .toast-container {
      z-index: 1055;
    }
/* navbar */
.navbar-center .nav-home {
    background-color: white;
    color: black;
}
.navbar {
    font-family: 'Azeret Mono', Arial, Helvetica, sans-serif;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    background-color: transparent;
    position: sticky;
    top: 0;
    z-index: 9999;
    width: 100%;
    box-sizing: border-box;
    transition: transform 0.3s ease; /* Thêm transition cho hiệu ứng ẩn/hiện */
}

.navbar.hidden {
    transform: translateY(-100%); /* Ẩn navbar bằng cách dịch chuyển lên trên */
}

.navbar-left {
    font-size: 24px;
    font-weight: bold;
    color: #000;
    padding: 8px 16px;
    z-index: 10000;
}

.navbar-center {
    display: flex;
    gap: 15px;
    z-index: 10000;
}

.navbar-center a {
    text-decoration: none;
    color: #000;
    font-size: 16px;
    padding: 8px 16px;
    border: 1px solid #000;
    border-radius: 20px;
    background-color: rgb(255, 255, 255);
    transition: background-color 0.3s, color 0.3s, border-color 0.3s;
}

.navbar-center a:hover {
    background-color: #000;
    color: #fff;
    border-color: #fff;
}

.navbar-center .active {
    background-color: black;
    color: white;
    border: 1px solid #000;
}

.navbar-center .active:hover {
    background-color: #000;
    color: #fff;
    border-color: #fff;
}

.navbar-right {
    display: flex;
    gap: 15px;
    z-index: 10000;
}

.navbar-right a {
    text-decoration: none;
    color: #000;
    font-size: 16px;
    padding: 8px 16px;
    border: 1px solid #000;
    border-radius: 20px;
    background-color: rgb(255, 255, 255);
    transition: background-color 0.3s, color 0.3s, border-color 0.3s;
}

.navbar-right a:hover {
    background-color: #000;
    color: #fff;
    border-color: #fff;
}

.navbar-right .highlight {
    background-color: rgb(255, 255, 255);
    border: 1px solid #000;
    font-weight: bold;
}

.navbar-right .highlight:hover {
    background-color: #000;
    color: #fff;
    border-color: #fff;
}
  </style>
</head>
<body>
      <!-- navbar -->
    <nav class="navbar">
        <div class="navbar-left">DONKIES</div>
        <div class="navbar-center">
            <a href="/" class="nav-home">HOME</a>
            <a href="/#about-section" class="nav-about">ABOUT</a>
            <a href="/products" class="nav-products">PRODUCTS</a>
            <a href="/#gallery-wrapper" class="nav-media">MEDIA</a>
            {% if session.customer_id %}
                <a href="/acc/myACC/my_account.html" class="nav-account active">myACCOUNT</a>
            {% else %}
                <a href="/login" class="nav-account">myACCOUNT</a>
            {% endif %}
        </div>
        <div class="navbar-right">
            {% if session.customer_id %}
                <a href="/logout" class="nav-logout highlight">LOGOUT</a>
            {% else %}
                <a href="/login" class="nav-login highlight">LOGIN</a>
            {% endif %}
        </div>
    </nav>
  <!-- Toast for notifications -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="addressToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto" id="toastTitle"></strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body"></div>
    </div>
  </div>
  <div class="container">
    <!-- New Navigation Bar -->
    <nav class="nav-container22">
      <ul class="nav-list22">

        <li class="nav-item22">
          <a class="nav-link22" href="my_account.html" data-tab="my-account22">My Account</a>
        </li>
        <li class="nav-item22">
          <a class="nav-link22" href="my_order.html" data-tab="my-orders22">My Orders</a>
        </li>
                <li class="nav-item22">
          <a class="nav-link22 active" href="my_address.html" data-tab="my-addresses22">My Addresses</a>
        </li>
      </ul>
    </nav>

    <!-- Address Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2>My Address</h2>
        <p class="text-muted">Add and manage the addresses you use often.</p>
      </div>
      <button class="btn btn-custom-update" data-bs-toggle="modal" data-bs-target="#addAddressModal">Add new address</button>
    </div>

    <!-- Address List -->
    <div class="card px-4 py-5 my-5" style="min-height: 450px;">
      <div id="addressList" class="address-list">
        <p class="lead mb-4">You haven't saved any addresses yet</p>
        <button class="btn btn-custom-update" data-bs-toggle="modal" data-bs-target="#addAddressModal">Add new address</button>
      </div>
    </div>
  </div>

  <!-- Modal for Adding/Updating Address -->
  <div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addAddressModalLabel">Add New Address</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="map"></div>
          <form id="addressForm">
            <input type="hidden" id="addressId" value="">
            <div class="mb-3">
              <label class="form-label">Contact Name</label>
              <input type="text" class="form-control" id="contactNameInput" placeholder="Enter name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Phone Number</label>
              <input type="tel" class="form-control" id="phoneInput" placeholder="Enter phone number" required>
            </div>
            <div class="mb-3 position-relative">
              <label class="form-label">Address</label>
              <input type="text" class="form-control" id="addressInput" placeholder="Enter address" required>
              <ul id="addressSuggestions" class="list-group" style="display: none; position: absolute; width: 100%; z-index: 1000;"></ul>
            </div>
            <div class="mb-3">
              <label class="form-check-label">
                <input type="checkbox" class="form-check-input" id="defaultAddress"> Set as default address
              </label>
            </div>
            <button type="submit" class="btn btn-custom-update w-100 mb-2">Save Address</button>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-custom-discard" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="footer-main">
      <div class="footer-left">
        <h1>DONKIES <img src="{{ url_for('serve_assets', filename='logo2.png') }}" alt="star icon" class="star-icon"></h1>
      </div>
      <div class="footer-center">
        <ul>
          <li>HOME</li>
          <li>ABOUT</li>
          <li>PRODUCTS</li>
          <li>MEDIA</li>
          <li>myACCOUNT</li>
        </ul>
      </div>
      <div class="footer-right">
        <p>ABC@GMAIL.COM</p>
        <p>123-456-7890</p>
        <p>123 HAI BA TRUNG</p>
        <p>DONG DA, HA NOI</p>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="social-icons">
        <a href="#" class="icon-circle"><i class="fab fa-youtube"></i></a>
        <a href="#" class="icon-circle"><i class="fab fa-facebook-f"></i></a>
        <a href="#" class="icon-circle"><i class="fab fa-instagram"></i></a>
        <a href="#" class="icon-circle"><i class="fab fa-linkedin-in"></i></a>
      </div>
      <div class="footer-links">
                <a href="{{ url_for('serve_assets', filename='privacy.html') }}">Privacy Policy</a>
                <a href="{{ url_for('serve_assets', filename='privacy.html') }}">Accessibility Statement</a>
      </div>
      <div class="copyright">
        © 2025 by G2 vo dich.
      </div>
    </div>
  </footer>

  <script src="https://kit.fontawesome.com/6026c58141.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Scroll event for navbar hide/show
    let lastScrollTop = 0;
    let hideTimeout = null;

    window.addEventListener('scroll', function() {
      const navbar = document.querySelector('.nav-container22');
      const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;

      if (hideTimeout) {
        clearTimeout(hideTimeout);
      }

      if (currentScrollTop < lastScrollTop) {
        navbar.classList.remove('hidden');
      } else if (currentScrollTop > lastScrollTop && currentScrollTop > 0) {
        hideTimeout = setTimeout(() => {
          navbar.classList.add('hidden');
        }, 500);
      }

      lastScrollTop = currentScrollTop <= 0 ? 0 : currentScrollTop;
    });

    // Initialize map
    let map, marker;
    document.getElementById('addAddressModal').addEventListener('shown.bs.modal', function () {
      if (!map) {
        map = L.map('map').setView([21.0285, 105.8542], 13); // Default to Hanoi
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        marker = L.marker([21.0285, 105.8542]).addTo(map);
      }
      setTimeout(() => map.invalidateSize(), 100); // Ensure map renders correctly
    });

    // Address suggestion handling
    const addressInput = document.getElementById('addressInput');
    const suggestionsList = document.getElementById('addressSuggestions');
    let debounceTimeout;

    addressInput.addEventListener('input', function() {
      clearTimeout(debounceTimeout);
      const query = this.value.trim();
      if (query.length < 3) {
        suggestionsList.style.display = 'none';
        return;
      }

      debounceTimeout = setTimeout(async () => {
        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`, {
            headers: { 'User-Agent': 'DonkiesCoffeeShop/1.0' }
          });
          if (!response.ok) throw new Error('Network response was not ok');
          const data = await response.json();
          suggestionsList.innerHTML = '';
          if (data.length > 0) {
            data.forEach(item => {
              const li = document.createElement('li');
              li.className = 'list-group-item';
              li.style.cursor = 'pointer';
              li.textContent = item.display_name;
              li.dataset.lat = item.lat;
              li.dataset.lon = item.lon;
              li.addEventListener('click', function() {
                addressInput.value = item.display_name;
                suggestionsList.style.display = 'none';
                const lat = parseFloat(item.lat);
                const lon = parseFloat(item.lon);
                map.setView([lat, lon], 15);
                marker.setLatLng([lat, lon]);
              });
              suggestionsList.appendChild(li);
            });
            suggestionsList.style.display = 'block';
          } else {
            suggestionsList.style.display = 'none';
          }
        } catch (error) {
          console.error('Error fetching address suggestions:', error);
          suggestionsList.style.display = 'none';
        }
      }, 300); // Debounce delay
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
      if (!addressInput.contains(e.target) && !suggestionsList.contains(e.target)) {
        suggestionsList.style.display = 'none';
      }
    });

    // Show toast notification
    function showToast(title, message, isError = false) {
      const toast = new bootstrap.Toast(document.getElementById('addressToast'));
      const toastElement = document.getElementById('addressToast');
      document.getElementById('toastTitle').textContent = title;
      document.querySelector('#addressToast .toast-body').textContent = message;
      toastElement.classList.remove('bg-success', 'bg-danger');
      toastElement.classList.add(isError ? 'bg-danger' : 'bg-success');
      toastElement.classList.add('text-white');
      toast.show();
    }

    // Load addresses from the backend
    async function loadAddresses() {
      const addressList = document.getElementById('addressList');
      try {
        const response = await fetch('/api/addresses');
        if (!response.ok) throw new Error('Failed to fetch addresses');
        const addresses = await response.json();
        console.log('Fetched addresses:', addresses); // Debugging log

        if (addresses.length > 0) {
          addressList.innerHTML = '';
          addresses.forEach((address) => {
            const addressDiv = document.createElement('div');
            addressDiv.className = 'address-item';
            addressDiv.innerHTML = `
              <div>
                <p><strong>${address.contact_name}</strong> (${address.phone})</p>
                <p>${address.address}</p>
                ${address.is_default ? '<span class="default-badge">Default</span>' : ''}
              </div>
              <div class="address-actions">
                <button class="btn address-action-btn update-address" data-bs-toggle="modal" data-bs-target="#addAddressModal" data-address-id="${address.address_id}">Update</button>
                <button class="btn address-action-btn set-default-address" data-address-id="${address.address_id}" ${address.is_default ? 'disabled data-bs-toggle="tooltip" data-bs-placement="top" title="This is already the default address"' : ''}>${address.is_default ? 'Default Set' : 'Set Default'}</button>
                <button class="btn address-action-btn delete-address" data-address-id="${address.address_id}" ${address.is_default ? 'disabled data-bs-toggle="tooltip" data-bs-placement="top" title="Cannot delete the default address"' : ''}>Delete</button>
              </div>
            `;
            addressList.appendChild(addressDiv);
          });

          // Initialize Bootstrap tooltips
          const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
          tooltipTriggerList.forEach(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

          // Add event listeners for update buttons
          document.querySelectorAll('.update-address').forEach(button => {
            button.addEventListener('click', async function() {
              const addressId = this.dataset.addressId;
              const address = addresses.find(addr => addr.address_id === addressId);
              console.log('Updating address:', address); // Debugging log
              document.getElementById('addAddressModalLabel').textContent = 'Update Address';
              document.getElementById('addressId').value = address.address_id;
              document.getElementById('contactNameInput').value = address.contact_name;
              document.getElementById('phoneInput').value = address.phone;
              document.getElementById('addressInput').value = address.address;
              document.getElementById('defaultAddress').checked = address.is_default;

              // Fetch coordinates for the address
              try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address.address)}&addressdetails=1&limit=1`, {
                  headers: { 'User-Agent': 'DonkiesCoffeeShop/1.0' }
                });
                if (response.ok) {
                  const data = await response.json();
                  if (data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    map.setView([lat, lon], 15);
                    marker.setLatLng([lat, lon]);
                  } else {
                    map.setView([21.0285, 105.8542], 13); // Fallback to Hanoi
                    marker.setLatLng([21.0285, 105.8542]);
                  }
                } else {
                  map.setView([21.0285, 105.8542], 13); // Fallback to Hanoi
                  marker.setLatLng([21.0285, 105.8542]);
                }
              } catch (error) {
                console.error('Error fetching coordinates for update:', error);
                map.setView([21.0285, 105.8542], 13); // Fallback to Hanoi
                marker.setLatLng([21.0285, 105.8542]);
              }
            });
          });

          // Add event listeners for set default buttons
          document.querySelectorAll('.set-default-address').forEach(button => {
            button.addEventListener('click', async function() {
              if (this.disabled) return; // Prevent action if already default
              const addressId = this.dataset.addressId;
              console.log('Setting default address:', addressId); // Debugging log
              try {
                const response = await fetch(`/api/addresses/set-default/${addressId}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(errorData.error || 'Failed to set default address');
                }
                showToast('Success', 'Address set as default successfully');
                loadAddresses();
              } catch (error) {
                console.error('Error setting default address:', error);
                showToast('Error', `Failed to set default address: ${error.message}`, true);
              }
            });
          });

          // Add event listeners for delete buttons
          document.querySelectorAll('.delete-address').forEach(button => {
            button.addEventListener('click', async function() {
              if (this.disabled) return; // Prevent action if default
              const addressId = this.dataset.addressId;
              console.log('Deleting address:', addressId); // Debugging log
              if (!confirm('Are you sure you want to delete this address?')) return;
              try {
                const response = await fetch(`/api/addresses/${addressId}`, {
                  method: 'DELETE',
                  headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(errorData.error || 'Failed to delete address');
                }
                showToast('Success', 'Address deleted successfully');
                loadAddresses();
              } catch (error) {
                console.error('Error deleting address:', error);
                showToast('Error', `Failed to delete address: ${error.message}`, true);
              }
            });
          });
        } else {
          addressList.innerHTML = `
            <p class="lead mb-4">You haven't saved any addresses yet</p>
            <button class="btn btn-custom-update" data-bs-toggle="modal" data-bs-target="#addAddressModal">Add new address</button>
            <hr>
          `;
        }
      } catch (error) {
        console.error('Error loading addresses:', error);
        addressList.innerHTML = `
          <p class="lead mb-4">Error loading addresses</p>
          <button class="btn btn-custom-update" data-bs-toggle="modal" data-bs-target="#addAddressModal">Add new address</button>
          <hr>
        `;
        showToast('Error', 'Failed to load addresses', true);
      }
    }

    // Address form handling
    document.getElementById('addressForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const addressId = document.getElementById('addressId').value;
      const contactName = document.getElementById('contactNameInput').value;
      const phone = document.getElementById('phoneInput').value;
      const address = document.getElementById('addressInput').value;
      const isDefault = document.getElementById('defaultAddress').checked;

      const data = {
        contact_name: contactName,
        phone: phone,
        address: address,
        is_default: isDefault
      };
      console.log('Submitting address:', data, 'addressId:', addressId); // Debugging log

      try {
        let response;
        if (!addressId) {
          // Add new address
          response = await fetch('/api/addresses', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          // Update existing address
          response = await fetch(`/api/addresses/${addressId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to save address');
        }
        const result = await response.json();

        // If adding a new address with is_default true, reset other addresses
        if (!addressId && isDefault) {
          try {
            const resetResponse = await fetch('/api/addresses/reset-default', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ exclude_address_id: result.address_id }) // Pass the new address ID to exclude it
            });
            if (!resetResponse.ok) {
              const errorData = await resetResponse.json();
              console.error('Error resetting other addresses:', errorData);
            }
          } catch (error) {
            console.error('Error resetting default status for other addresses:', error);
          }
        }

        // Get modal instance
        const modal = bootstrap.Modal.getInstance(document.getElementById('addAddressModal'));

        // Reset form and modal state
        this.reset();
        document.getElementById('addAddressModalLabel').textContent = 'Add New Address';
        document.getElementById('addressId').value = '';
        document.getElementById('contactNameInput').value = '';
        document.getElementById('phoneInput').value = '';
        document.getElementById('addressInput').value = '';
        document.getElementById('defaultAddress').checked = false;
        map.setView([21.0285, 105.8542], 13);
        marker.setLatLng([21.0285, 105.8542]);

        // Close modal and wait for it to be fully hidden before reloading
        modal.hide();
        document.getElementById('addAddressModal').addEventListener('hidden.bs.modal', function handler() {
          loadAddresses();
          showToast('Success', result.message || 'Address saved successfully');
          // Remove the event listener to prevent multiple bindings
          this.removeEventListener('hidden.bs.modal', handler);
        }, { once: true });
      } catch (error) {
        console.error('Error saving address:', error);
        showToast('Error', `Failed to save address: ${error.message}`, true);
      }
    });

    // Reset modal when opened for adding new address
    document.getElementById('addAddressModal').addEventListener('show.bs.modal', function(e) {
      if (!e.relatedTarget.classList.contains('update-address')) {
        document.getElementById('addressForm').reset();
        document.getElementById('addAddressModalLabel').textContent = 'Add New Address';
        document.getElementById('addressId').value = '';
        document.getElementById('contactNameInput').value = '';
        document.getElementById('phoneInput').value = '';
        document.getElementById('addressInput').value = '';
        document.getElementById('defaultAddress').checked = false;
        map.setView([21.0285, 105.8542], 13);
        marker.setLatLng([21.0285, 105.8542]);
      }
    });

    // Load addresses on page load
    window.addEventListener('load', loadAddresses);
  </script>
</body>
</html>